{"version":3,"sources":["../../src/targets/RendererTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { outputFile, readFile } from \"fs-extra\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig } from \"read-config-file\"\nimport { DefinePlugin } from \"webpack\"\nimport { getDllAssets } from \"../configurators/dll\"\nimport { configureVueRenderer } from \"../configurators/vue/vue\"\nimport { WebpackConfigurator } from \"../main\"\nimport { statOrNull } from \"../util\"\nimport { BaseTarget, configureFileLoader } from \"./BaseTarget\"\n\nconst MiniCssExtractPlugin = require(\"mini-css-extract-plugin\")\n\nexport class BaseRendererTarget extends BaseTarget {\n  constructor() {\n    super()\n  }\n\n  configureRules(configurator: WebpackConfigurator): void {\n    super.configureRules(configurator)\n\n    configurator.extensions.push(\".css\")\n\n    const miniLoaders = [MiniCssExtractPlugin.loader, { loader: \"css-loader\", options: { modules: \"global\" } }]\n    const cssHotLoader = configurator.isProduction ? miniLoaders : [\"css-hot-loader\"].concat(miniLoaders)\n    if (!configurator.isProduction) {\n      // https://github.com/shepherdwind/css-hot-loader/issues/37\n      configurator.entryFiles.unshift(\"css-hot-loader/hotModuleReplacement\")\n    }\n\n    configurator.rules.push(\n      {\n        test: /\\.css$/,\n        use: cssHotLoader,\n      },\n      {\n        test: /\\.less$/,\n        use: cssHotLoader.concat(\"less-loader\"),\n      },\n      {\n        test: /\\.s([ac])ss$/,\n        use: cssHotLoader.concat(\"sass-loader\"),\n      },\n      {\n        test: /\\.(png|jpe?g|gif|svg)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"imgs\")\n        }\n      },\n      {\n        test: /\\.(mp4|webm|ogg|mp3|wav|flac|aac)(\\?.*)?$/,\n        loader: \"url-loader\",\n        options: configureFileLoader(\"media\"),\n      },\n      {\n        test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"fonts\")\n        }\n      },\n    )\n\n    if (configurator.hasDevDependency(\"ejs-html-loader\")) {\n      configurator.rules.push({\n        test: /\\.ejs$/,\n        loader: \"ejs-html-loader\",\n      })\n    }\n\n    if (configurator.hasDependency(\"vue\")) {\n      configureVueRenderer(configurator)\n    }\n    else {\n      configurator.rules.push({\n        test: /\\.(html)$/,\n        use: {\n          loader: \"html-loader\",\n        }\n      })\n    }\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    configurator.debug(\"Add ExtractTextPlugin plugin\")\n    configurator.plugins.push(new MiniCssExtractPlugin({filename: `${configurator.type === \"renderer-dll\" ? \"vendor\" : \"styles\"}.css`}))\n\n    await BaseTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nexport class RendererTarget extends BaseRendererTarget {\n  constructor() {\n    super()\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    // not configurable for now, as in the electron-vue\n    const customTemplateFile = path.join(configurator.projectDir, configurator.rendererTemplate)\n    const HtmlWebpackPlugin = require(\"html-webpack-plugin\")\n    const nodeModulePath = configurator.isProduction ? null : path.resolve(require.resolve(\"electron\"), \"..\", \"..\")\n\n    let template\n    if (await statOrNull(customTemplateFile)) {\n      template = await readFile(customTemplateFile, {encoding: \"utf8\"})\n    }\n    else {\n      template = getDefaultIndexTemplate()\n    }\n\n    configurator.plugins.push(new HtmlWebpackPlugin({\n      filename: \"index.html\",\n      template: await generateIndexFile(configurator, nodeModulePath, template),\n      minify: false,\n      nodeModules: nodeModulePath\n    }))\n\n    if (configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        __static: `process.resourcesPath + \"/${configurator.staticSourceDirectory}\"`\n      }))\n    }\n    else {\n      const contentBase = [path.join(configurator.projectDir, configurator.staticSourceDirectory), path.join(configurator.commonDistDirectory, \"renderer-dll\")];\n      (configurator.config as any).devServer = {\n        contentBase,\n        host: process.env.ELECTRON_WEBPACK_WDS_HOST || \"localhost\",\n        port: process.env.ELECTRON_WEBPACK_WDS_PORT || 9080,\n        hot: true,\n        overlay: true,\n      }\n    }\n\n    await BaseRendererTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nasync function computeTitle(configurator: WebpackConfigurator): Promise<string | null | undefined> {\n  const titleFromOptions = configurator.electronWebpackConfiguration.title\n  if (titleFromOptions == null || titleFromOptions === false) {\n    return null\n  }\n\n  if (titleFromOptions !== true) {\n    return titleFromOptions\n  }\n\n  let title: string | null | undefined = (configurator.metadata as any).productName\n  if (title == null) {\n    const electronBuilderConfig = await getConfig<any>({\n      packageKey: \"build\",\n      configFilename: \"electron-builder\",\n      projectDir: configurator.projectDir,\n      packageMetadata: new Lazy(() => Promise.resolve(configurator.metadata))\n    })\n    if (electronBuilderConfig != null) {\n      title = electronBuilderConfig.result.productName\n    }\n  }\n\n  if (title == null) {\n    title = configurator.metadata.name\n  }\n  return title\n}\n\nfunction getDefaultIndexTemplate() {\n  return `<!DOCTYPE html>\n    <html>\n      <head>\n        <meta charset=\"utf-8\">\n      </head>\n      <body>\n        <div id=\"app\"></div>\n      </body>\n    </html>`\n}\n\nasync function generateIndexFile(configurator: WebpackConfigurator, nodeModulePath: string | null, template: string) {\n  // do not use add-asset-html-webpack-plugin - no need to copy vendor files to output (in dev mode will be served directly, in production copied)\n  const assets = await getDllAssets(path.join(configurator.commonDistDirectory, \"renderer-dll\"), configurator)\n  const scripts: Array<string> = []\n  const css: Array<string> = []\n  for (const asset of assets) {\n    if (asset.endsWith(\".js\")) {\n      scripts.push(`<script type=\"text/javascript\" src=\"${asset}\"></script>`)\n    }\n    else {\n      css.push(`<link rel=\"stylesheet\" href=\"${asset}\">`)\n    }\n  }\n\n  const title = await computeTitle(configurator)\n  const filePath = path.join(configurator.commonDistDirectory, \".renderer-index-template.html\")\n\n  let html = template\n  if (title) {\n    html = html.replace(\"</head>\", `<title>${title}</title></head>`)\n  }\n\n  if (nodeModulePath) {\n    html = html.replace(\"</head>\", `<script>require('module').globalPaths.push(\"${nodeModulePath.replace(/\\\\/g, \"/\")}\")</script></head>`)\n  }\n\n  html = html.replace(\"</head>\", '<script>require(\"source-map-support/source-map-support.js\").install()</script></head>')\n\n  if (scripts.length) {\n    html = html.replace(\"</head>\", `${scripts.join(\"\")}</head>`)\n  }\n\n  if (css.length) {\n    html = html.replace(\"</head>\", `${css.join(\"\")}</head>`)\n  }\n\n  await outputFile(filePath, html)\n\n  return `!!html-loader?minimize=false&url=false!${filePath}`\n}\n"],"sourceRoot":""}
