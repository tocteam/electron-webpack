{"version":3,"sources":["../../src/plugins/WebpackRemoveOldAssetsPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import * as bluebird from \"bluebird\"\nimport { lstat, readdir, remove, Stats } from \"fs-extra\"\nimport * as path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { orNullIfFileNotExist } from \"../util\"\n\nexport const MAX_FILE_REQUESTS = 8\nexport const CONCURRENCY = {concurrency: MAX_FILE_REQUESTS}\n\nconst debug = require(\"debug\")(\"electron-webpack:clean\")\n\nexport async function walk(initialDirPath: string, filter?: Filter | null): Promise<Array<string>> {\n  const result: Array<string> = []\n  const queue: Array<string> = [initialDirPath]\n  let addDirToResult = false\n  while (queue.length > 0) {\n    const dirPath = queue.pop()!\n\n    const childNames = await orNullIfFileNotExist(readdir(dirPath))\n    if (childNames == null) {\n      continue\n    }\n\n    if (addDirToResult) {\n      result.push(dirPath)\n    }\n    else {\n      addDirToResult = true\n    }\n\n    childNames.sort()\n\n    const dirs: Array<string> = []\n    // our handler is async, but we should add sorted files, so, we add file to result not in the mapper, but after map\n    const sortedFilePaths = await bluebird.map(childNames, name => {\n      const filePath = dirPath + path.sep + name\n      return lstat(filePath)\n        .then(stat => {\n          if (filter != null && !filter(filePath, stat)) {\n            return null\n          }\n\n          if (stat.isDirectory()) {\n            dirs.push(name)\n            return null\n          }\n          else {\n            return filePath\n          }\n        })\n    }, CONCURRENCY)\n\n    for (const child of sortedFilePaths) {\n      if (child != null) {\n        result.push(child)\n      }\n    }\n\n    dirs.sort()\n    for (const child of dirs) {\n      queue.push(dirPath + path.sep + child)\n    }\n  }\n\n  return result\n}\n\nexport type Filter = (file: string, stat: Stats) => boolean\n\nexport class WebpackRemoveOldAssetsPlugin {\n  constructor(private readonly dllManifest: string | null) {\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.afterEmit.tapAsync(\"WebpackRemoveOldAssetsPlugin\", (compilation: any, callback: (error?: Error) => void) => {\n      const newlyCreatedAssets = compilation.assets\n      const outDir = compiler.options.output!.path!\n      walk(outDir, (file, stat) => {\n        // dll plugin\n        if (file === this.dllManifest) {\n          return false\n        }\n\n        const relativePath = file.substring(outDir.length + 1)\n        if (stat.isFile()) {\n          return newlyCreatedAssets[relativePath] == null\n        }\n        else if (stat.isDirectory()) {\n          for (const p of Object.keys(newlyCreatedAssets)) {\n            if (p.length > relativePath.length && (p[relativePath.length] === \"/\" || p[relativePath.length] === \"\\\\\") && p.startsWith(relativePath)) {\n              return false\n            }\n          }\n          return true\n        }\n        return false\n      })\n        .then((it): any => {\n          if (it.length === 0) {\n            return null\n          }\n\n          if (debug.enabled) {\n            debug(`Remove outdated files:\\n  ${it.join(\"\\n  \")}`)\n          }\n          return bluebird.map(it, it => remove(it), CONCURRENCY)\n        })\n        .then(() => callback())\n        .catch(callback)\n    })\n  }\n}\n"],"sourceRoot":""}
